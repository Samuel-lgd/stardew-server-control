<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Contrôle serveur</title>
<style>
body{font-family:Arial; padding:20px; max-width:480px}
button{margin:5px 0;padding:8px 12px}
#ip{font-weight:600}
</style>
</head>
<body>
<h3>Contrôle serveur</h3>
<input id="pw" type="password" placeholder="Mot de passe" style="width:100%"/><br>
<button id="start">Démarrer</button>
<button id="stop">Arrêter</button>
<button id="refresh">Récupérer IP</button>
<p id="status">—</p>
<p>IP : <span id="ip">aucune</span>
<button id="copy" style="display:inline-block">Copier</button></p>

<script>
const API_BASE = "https://XXXXXX.execute-api.REGION.amazonaws.com/control"; // remplace
const PORT_SUFFIX = ":24642";
const POLL_INTERVAL = 3000; // ms
const POLL_MAX = 20; // essais

function hdrs(pw){
  return { "X-Password": pw };
}

async function request(action){
  const pw = document.getElementById("pw").value;
  if(!pw){ alert("Mot de passe requis"); return null; }
  const url = API_BASE + "?action=" + encodeURIComponent(action);
  try {
    const r = await fetch(url, { method:"GET", headers: hdrs(pw) });
    const txt = await r.text();
    try { return { ok: r.ok, body: JSON.parse(txt), status: r.status }; } 
    catch(e){ return { ok:r.ok, body: txt, status:r.status }; }
  } catch(e){
    return { ok:false, error: e.toString() };
  }
}

async function pollForIP(){
  document.getElementById("status").innerText = "Recherche de l'IP...";
  for(let i=0;i<POLL_MAX;i++){
    const res = await request("get-ip");
    if(!res) break;
    if(res.ok && res.body && res.body.public_ip){
      const ip = res.body.public_ip;
      document.getElementById("ip").innerText = ip + PORT_SUFFIX;
      document.getElementById("status").innerText = "Instance " + res.body.instance_state;
      return ip;
    }
    document.getElementById("status").innerText = `Essai ${i+1}/${POLL_MAX} — état: ${res.body?.instance_state || 'inconnu'}`;
    await new Promise(r=>setTimeout(r,POLL_INTERVAL));
  }
  document.getElementById("status").innerText = "IP non disponible (timeout).";
  return null;
}

document.getElementById("start").addEventListener("click", async ()=>{
  document.getElementById("status").innerText = "Envoi start...";
  await request("start");
  await pollForIP();
});

document.getElementById("stop").addEventListener("click", async ()=>{
  document.getElementById("status").innerText = "Envoi stop...";
  await request("stop");
  // clear ip
  document.getElementById("ip").innerText = "aucune";
});

document.getElementById("refresh").addEventListener("click", async ()=>{
  await pollForIP();
});

document.getElementById("copy").addEventListener("click", async ()=>{
  const text = document.getElementById("ip").innerText;
  if(!text || text === "aucune"){ alert("Aucune IP à copier"); return; }
  try{
    await navigator.clipboard.writeText(text);
    alert("Copié: " + text);
  }catch(e){
    // fallback
    const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
    alert("Copié: " + text);
  }
});
</script>
</body>
</html>
